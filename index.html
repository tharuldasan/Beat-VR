<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component/dist/aframe-environment-component.min.js"></script>
  </head>
  <body>
    <a-scene vr-mode-ui="enabled: true">
      
      <a-assets>
        <audio id="sliceSound" src="https://cdn.glitch.com/sounds/slice.mp3"></audio>
      </a-assets>

      <a-entity environment="preset: night; neonColor: cyan; ground: hills;"></a-entity>

      <a-entity id="rig" position="0 1.6 0" look-controls>
        <a-entity camera position="0 0 0">
          
          <a-entity cursor="fuse: true; fuseTimeout: 5000"
                    position="0 0 -1"
                    geometry="primitive: ring; radiusInner: 0.015; radiusOuter: 0.02"
                    material="color: black; shader: flat">
            <a-animation begin="fusing" easing="ease-in" attribute="scale"
                         fill="forwards" from="1 1 1" to="0.1 0.1 0.1" dur="5000"></a-animation>
          </a-entity>

        </a-entity>

        <a-entity id="saber-hand" position="0.4 -0.5 -0.8">
            <a-cylinder height="0.25" radius="0.03" color="#111" metalness="1"></a-cylinder>
            <a-cylinder height="0.9" radius="0.02" color="cyan" emissive="cyan" position="0 0.55 0">
                <a-sphere radius="0.02" position="0 0.45 0" color="cyan" emissive="cyan"></a-sphere>
            </a-cylinder>
        </a-entity>
      </a-entity>

      <a-entity id="menu" position="0 1.5 -3">
          <a-box id="btn-start" class="clickable" width="1.5" height="0.6" depth="0.1" color="#222"
                 onclick="startGame()">
              <a-text value="LEVEL 01" align="center" position="0 0 0.12" color="cyan"></a-text>
          </a-box>
      </a-entity>

    </a-scene>

    <script>
      const saber = document.querySelector('#saber-hand');

      // Connect Arduino via Bluetooth
      window.addEventListener('click', async () => {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ name: 'HC-05' }],
          optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb']
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
        const char = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
        
        char.startNotifications();
        char.addEventListener('characteristicvaluechanged', (e) => {
          let val = new TextDecoder().decode(e.target.value);
          let coords = val.split(','); // Arduino sends "X,Y"
          let xMove = (parseInt(coords[0]) - 150) / 100;
          let yMove = (parseInt(coords[1]) - 150) / 100;
          
          // Moves the saber relative to where you are looking
          saber.setAttribute('position', {x: xMove + 0.4, y: yMove - 0.5, z: -0.8});
        });
      });

      function startGame() {
        document.querySelector('#menu').setAttribute('visible', 'false');
        console.log("5 Seconds Over: Game Starting!");
      }
    </script>
  </body>
</html>
